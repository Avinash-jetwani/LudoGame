Architecture & Data Model

Frontend
	•	React (Vite + TS) for UI and game logic.
	•	Zustand for local UI state (lobby prompts, dialog visibility, transient selections).
	•	Supabase JS for Auth and DB reads/writes; subscribe to realtime row changes on games, game_players, moves.
	•	SVG board renders tokens via computed (x,y) from track indices.

Key Concepts
	•	Single source of truth: the games row holds canonical board + turn + lastRoll. moves is an append‑only audit log.
	•	Client‑validated moves: UI prevents illegal actions; DB accepts only writes from in‑room players via RLS.
	•	Idempotence: Client includes last_seen_move_id; server state uses updated_at to avoid duplicate processing. (For MVP we rely on simple optimistic updates; if concurrent writes happen, last write wins and UI re‑calculates.)

Tables (Postgres)

-- enums
create type game_status as enum ('lobby','playing','finished','abandoned');
create type player_colour as enum ('red','yellow','green','blue');

-- games
create table public.games (
  id uuid primary key default gen_random_uuid(),
  status game_status not null default 'lobby',
  secret text not null,                         -- random, shared per room
  settings jsonb not null default '{"maxPlayers":4,"variant":"standard"}',
  board jsonb not null default '{
    "red":[-1,-1,-1,-1],
    "yellow":[-1,-1,-1,-1],
    "green":[-1,-1,-1,-1],
    "blue":[-1,-1,-1,-1]
  }',                                           -- token positions by colour
  turn player_colour,                           -- whose turn it is
  last_roll int,                                -- 1..6
  roll_streak int not null default 0,           -- consecutive 6s this turn
  winner player_colour,                         -- set when finished
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

-- game_players
create table public.game_players (
  id uuid primary key default gen_random_uuid(),
  game_id uuid not null references public.games(id) on delete cascade,
  user_id uuid not null,                        -- auth.uid() of supabase auth
  display_name text,
  colour player_colour not null,
  ready boolean not null default false,
  connected_at timestamptz not null default now(),
  unique (game_id, colour),
  unique (game_id, user_id)
);

-- moves (append‑only audit)
create table public.moves (
  id bigint generated by default as identity primary key,
  game_id uuid not null references public.games(id) on delete cascade,
  by_colour player_colour not null,
  piece_index int not null check (piece_index between 0 and 3),
  from_pos int not null,                         -- -1 yard, 0..51 track, 100..103 home slots
  to_pos int not null,
  roll int not null check (roll between 1 and 6),
  created_at timestamptz not null default now()
);

-- (optional) lightweight chat
create table public.messages (
  id bigint generated by default as identity primary key,
  game_id uuid not null references public.games(id) on delete cascade,
  user_id uuid not null,
  content text not null check (char_length(content) <= 200),
  created_at timestamptz not null default now()
);

Row Level Security (RLS) — high level

Enable RLS and restrict writes to players in the game.

alter table public.games enable row level security;
alter table public.game_players enable row level security;
alter table public.moves enable row level security;
alter table public.messages enable row level security;

-- Helper: is the authed user a player in this game?
create or replace function public.is_player(game uuid)
returns boolean language sql stable as $$
  select exists (
    select 1 from public.game_players gp
    where gp.game_id = game and gp.user_id = auth.uid()
  );
$$;

-- GAMES policies
create policy games_select on public.games
for select using ( true ); -- read‑only for anyone with the id; private link

create policy games_insert on public.games
for insert with check ( auth.uid() is not null );

create policy games_update on public.games
for update using ( public.is_player(id) )
with check ( public.is_player(id) );

-- GAME_PLAYERS policies
create policy gp_select on public.game_players for select using ( true );
create policy gp_insert on public.game_players for insert with check ( auth.uid() = user_id );
create policy gp_update on public.game_players for update using ( auth.uid() = user_id ) with check ( auth.uid() = user_id );

-- MOVES policies
create policy moves_select on public.moves for select using ( true );
create policy moves_insert on public.moves for insert with check ( public.is_player(game_id) );

-- MESSAGES policies
create policy messages_select on public.messages for select using ( public.is_player(game_id) );
create policy messages_insert on public.messages for insert with check ( public.is_player(game_id) );

Notes: (1) Allowing public select on games/game_players simplifies joining by room id; game secrecy hinges on the unguessable id + secret stored client‑side. You can tighten this later by requiring membership to read. (2) All writes gated by membership via is_player().

Realtime Wiring
	•	Subscribe to games:id=... row updates for board, turn, last_roll, status.
	•	Subscribe to game_players:game_id=... for lobby readiness and disconnects.
	•	Subscribe to moves:game_id=... for audit / replay (optional UI).

Board Representation
	•	Track indices: -1 = yard; 0..51 = outer ring; 100..103 = home slots per colour.
	•	Start indices: red:0, yellow:13, green:26, blue:39.
	•	Home‑entry indices: (start + 50) % 52.
	•	Safe squares (no capture): [0,8,13,21,26,34,39,47].

Movement Rules (summary)
	•	Enter: roll 6 from yard → token goes to startIndex if empty (safe squares can stack; you may define single‑stack safe if desired).
	•	Advance: from track position p with roll r → (p + r) % 52, unless passing home‑entry for your colour, in which case steps enter home path (100..103).
	•	Capture: landing on opponent on non‑safe track sends opponent back to yard.
	•	Home: you must land exactly on 100..103 slots; overshoot is invalid.
	•	Turn: roll of 6 grants another roll; three consecutive 6s in a row forfeits turn (no movement from the third 6).

UI Components (suggested)

src/
  components/
    Lobby.tsx          -- create/join, colour pick, ready state
    Board.tsx          -- renders SVG board + pieces
    Piece.tsx          -- clickable token
    Dice.tsx           -- roll button + last roll
    Controls.tsx       -- move chooser when multiple options
    Chat.tsx           -- (optional) emoji/short chat
  lib/
    supabase.ts        -- client init
    rules.ts           -- pure TS Ludo rules engine
    track.ts           -- index→(x,y) mapping
    store.ts           -- Zustand store
  pages/
    Home.tsx
    Game.tsx
